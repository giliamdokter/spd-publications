<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Publications</title>

<style>
/* ---- Squarespace-friendly professional styling ---- */
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif;
  line-height: 1.6;
  color: #222;
  margin: 0;
  padding: 0;
}

#controls {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

#search {
  flex: 1;
  padding: 0.6rem 0.7rem;
  font-size: 0.95rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

#yearFilter {
  padding: 0.6rem 0.7rem;
  font-size: 0.95rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: white;
}

.year {
  font-size: 1.4rem;
  font-weight: 600;
  margin-top: 2.5rem;
  border-bottom: 1px solid #ddd;
  padding-bottom: 0.3rem;
}

.pub {
  margin: 0.8rem 0;
  font-size: 0.95rem;
}

.pub a {
  color: inherit;
  text-decoration: underline;
}

.pub a:hover {
  text-decoration: none;
}

.loading {
  font-style: italic;
  color: #666;
}
</style>
</head>

<body>

<div id="controls">
  <input type="text" id="search" placeholder="Search publications…">
  <select id="yearFilter">
    <option value="all">All years</option>
  </select>
</div>

<div id="pubs" class="loading">Loading publications…</div>

<script>
/* ================================
   CONFIG
================================ */
const ORCIDS = [
  "0000-0002-5667-3293",
  "0000-0002-7382-1825",
  "0000-0003-0373-3720",
  "0000-0001-8466-8259",
  "0009-0008-1469-058X"
  // add all ORCID IDs here
];

/* ================================
   ORCID FETCHING
================================ */
async function fetchWorks(orcid) {
  const url = `https://pub.orcid.org/v3.0/${orcid}/works`;
  const res = await fetch(url, {
    headers: { "Accept": "application/json" }
  });
  const data = await res.json();
  return data.group || [];
}

/* ================================
   HELPERS
================================ */
function getYear(work) {
  return work["work-summary"][0]?.["publication-date"]?.year?.value || "Unknown";
}

function getDOI(work) {
  return work["work-summary"][0]?.["external-ids"]?.["external-id"]
    ?.find(id => id["external-id-type"] === "doi")
    ?.["external-id-value"];
}

function getTitle(work) {
  return work["work-summary"][0]?.title?.title?.value || "Untitled";
}

function getJournal(work) {
  return work["work-summary"][0]?.["journal-title"]?.value || "";
}

/* ================================
   APA-LIKE FORMAT
   (ORCID doesn't expose full author lists reliably;
    we pull author strings when available)
================================ */
function formatAPA(work) {
  const summary = work["work-summary"][0];
  const title = getTitle(work);
  const journal = getJournal(work);
  const year = getYear(work);
  const doi = getDOI(work);

  let citation = "";

  if (summary?.contributors?.contributor?.length) {
    const authors = summary.contributors.contributor
      .map(c => c["credit-name"]?.value)
      .filter(Boolean)
      .join(", ");
    citation += `${authors}. `;
  }

  citation += `(${year}). <strong>${title}</strong>. `;
  if (journal) citation += `<em>${journal}</em>. `;
  if (doi) citation += `<a href="https://doi.org/${doi}" target="_blank">https://doi.org/${doi}</a>`;

  return citation;
}

/* ================================
   LOAD + PROCESS
================================ */
let allPubs = [];

async function loadPublications() {
  let works = [];

  for (const id of ORCIDS) {
    const pubs = await fetchWorks(id);
    works = works.concat(pubs);
  }

  /* Deduplicate by title */
  const seen = new Set();
  works = works.filter(w => {
    const t = getTitle(w);
    if (!t || seen.has(t)) return false;
    seen.add(t);
    return true;
  });

  /* Sort newest first */
  works.sort((a, b) => getYear(b) - getYear(a));

  allPubs = works;
  populateYearFilter();
  render();
}

/* ================================
   UI
================================ */
function populateYearFilter() {
  const years = [...new Set(allPubs.map(w => getYear(w)))].sort((a,b) => b-a);
  const select = document.getElementById("yearFilter");
  years.forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    select.appendChild(opt);
  });
}

function render() {
  const container = document.getElementById("pubs");
  const searchTerm = document.getElementById("search").value.toLowerCase();
  const year = document.getElementById("yearFilter").value;

  container.innerHTML = "";

  let filtered = allPubs.filter(w => {
    const text = formatAPA(w).toLowerCase();
    const yearMatch = (year === "all" || getYear(w) === year);
    const searchMatch = text.includes(searchTerm);
    return yearMatch && searchMatch;
  });

  if (!filtered.length) {
    container.innerHTML = "<p class='loading'>No matching publications.</p>";
    return;
  }

  const grouped = {};
  filtered.forEach(w => {
    const y = getYear(w);
    if (!grouped[y]) grouped[y] = [];
    grouped[y].push(w);
  });

  Object.keys(grouped).sort((a,b) => b-a).forEach(y => {
    const yearDiv = document.createElement("div");
    yearDiv.className = "year";
    yearDiv.textContent = y;
    container.appendChild(yearDiv);

    grouped[y].forEach(w => {
      const div = document.createElement("div");
      div.className = "pub";
      div.innerHTML = formatAPA(w);
      container.appendChild(div);
    });
  });
}

/* ================================
   EVENTS
================================ */
document.getElementById("search").addEventListener("input", render);
document.getElementById("yearFilter").addEventListener("change", render);

/* ================================
   INIT
================================ */
loadPublications();
</script>

</body>
</html>
