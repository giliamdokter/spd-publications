<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Publications</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: "Poppins", sans-serif; line-height:1.65; color:#222; margin:0; padding:0; }
#controls { display:flex; gap:1rem; margin-bottom:2rem; flex-wrap:wrap; }
#search, #yearFilter { padding:0.65rem 0.75rem; font-size:0.9rem; border:1px solid #ccc; border-radius:4px; font-family:inherit; }
#search{flex:1;}
.year { font-size:1.3rem; font-weight:600; margin-top:2.5rem; border-bottom:1px solid #ddd; padding-bottom:0.35rem; }
.pub { margin:0.85rem 0; font-size:0.92rem; }
.pub a { color:inherit; text-decoration:underline; }
.loading { font-style:normal; color:#666; }
</style>
</head>
<body>

<div id="controls">
  <input type="text" id="search" placeholder="Search publications…">
  <select id="yearFilter"><option value="all">All years</option></select>
</div>

<div id="pubs" class="loading">Loading publications…</div>

<script>
const ORCIDS = [
  "0000-0002-5667-3293",
  "0000-0002-7382-1825",
  "0000-0003-0373-3720",
  "0000-0001-8466-8259",
  "0009-0008-1469-058X"
  // add more ORCIDs
];
const YEAR_CUTOFF = 2015;
let allPubs = [];

// Fetch all works summaries per ORCID (fast)
async function fetchWorksSummary(orcid){
  try {
    const res = await fetch(`https://pub.orcid.org/v3.0/${orcid}/works`, { headers:{Accept:"application/json"} });
    const data = await res.json();
    return data.group || [];
  } catch(e){
    console.error("Failed to fetch ORCID works for", orcid, e);
    return [];
  }
}

// Extract year, title, DOI, journal, and authors from summary
function parseSummary(group){
  if(!group || !group.length) return null;
  const summary = group[0]["work-summary"][0]; // use first summary in group
  const year = parseInt(summary["publication-date"]?.year?.value) || 0;
  if(year < YEAR_CUTOFF) return null;

  // Use ORCID citation if available
  let authors = summary.citation?.citation?.value?.split("(")[0]?.trim() || "";
  // Fallback: use title if authors missing
  if(!authors && summary.title?.title?.value) authors = "";

  const title = summary.title?.title?.value || "Untitled";
  const journal = summary["journal-title"]?.value || "";
  const doi = summary["external-ids"]?.["external-id"]?.find(id=>id["external-id-type"]==="doi")?.["external-id-value"];

  return {year, title, journal, doi, authors};
}

// Format for display
function formatCitation(pub){
  let html = "";
  if(pub.authors) html += `<strong>${pub.authors}</strong> `;
  html += `(${pub.year}). ${pub.title}. `;
  if(pub.journal) html += `${pub.journal}. `;
  if(pub.doi) html += `<a href="https://doi.org/${pub.doi}" target="_blank">https://doi.org/${pub.doi}</a>`;
  return html;
}

// Populate year filter dropdown
function populateYearFilter(){
  const years = [...new Set(allPubs.map(p=>p.year))].sort((a,b)=>b-a);
  const sel = document.getElementById("yearFilter");
  sel.innerHTML = '<option value="all">All years</option>';
  years.forEach(y=>{
    const o = document.createElement("option"); o.value=y; o.textContent=y; sel.appendChild(o);
  });
}

// Render publications grouped by year
function render(){
  const q = document.getElementById("search").value.toLowerCase();
  const yf = document.getElementById("yearFilter").value;
  const c = document.getElementById("pubs");
  c.innerHTML="";

  const filtered = allPubs.filter(p=>{
    const t = formatCitation(p).toLowerCase();
    const yearMatch = yf==="all" || p.year.toString()===yf;
    return t.includes(q) && yearMatch;
  });

  if(!filtered.length){ c.innerHTML="<p class='loading'>No matching publications.</p>"; return; }

  const byYear = {};
  filtered.forEach(p=>{ byYear[p.year] ??= []; byYear[p.year].push(p); });

  Object.keys(byYear).sort((a,b)=>b-a).forEach(y=>{
    const h = document.createElement("div"); h.className="year"; h.textContent=y; c.appendChild(h);
    byYear[y].forEach(p=>{ const d=document.createElement("div"); d.className="pub"; d.innerHTML=formatCitation(p); c.appendChild(d); });
  });
}

// Load all summaries (1 request per ORCID)
async function loadPublications(){
  document.getElementById("pubs").innerHTML="<p class='loading'>Loading publications…</p>";
  const results = await Promise.all(ORCIDS.map(fetchWorksSummary));
  allPubs = results.flatMap(group=>parseSummary(group)?[parseSummary(group)]:[]);
  allPubs.sort((a,b)=>b.year - a.year);
  populateYearFilter();
  render();
}

document.getElementById("search").addEventListener("input", render);
document.getElementById("yearFilter").addEventListener("change", render);

loadPublications();
</script>

</body>
</html>
