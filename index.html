<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Publications</title>

<!-- Poppins font (Squarespace default-like) -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
/* ================================
   Squarespace-like professional styling
================================ */
body {
  font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
               "Helvetica Neue", Helvetica, Arial, sans-serif;
  line-height: 1.65;
  color: #222;
  margin: 0;
  padding: 0;
}

#controls {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
}

#search {
  flex: 1;
  padding: 0.65rem 0.75rem;
  font-size: 0.9rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-family: inherit;
}

#yearFilter {
  padding: 0.65rem 0.75rem;
  font-size: 0.9rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: white;
  font-family: inherit;
}

.year {
  font-size: 1.3rem;
  font-weight: 600;
  margin-top: 2.5rem;
  border-bottom: 1px solid #ddd;
  padding-bottom: 0.35rem;
}

.pub {
  margin: 0.85rem 0;
  font-size: 0.92rem;
}

.pub a {
  color: inherit;
  text-decoration: underline;
}

.pub a:hover {
  text-decoration: none;
}

.loading {
  font-style: italic;
  color: #666;
}
</style>
</head>

<body>

<div id="controls">
  <input type="text" id="search" placeholder="Search publications…">
  <select id="yearFilter">
    <option value="all">All years</option>
  </select>
</div>

<div id="pubs" class="loading">Loading publications…</div>

<script>
/* ================================
   CONFIG: ADD ORCID IDS HERE
================================ */
const ORCIDS = [
  "0000-0002-5667-3293",
  "0000-0002-7382-1825",
  "0000-0003-0373-3720",
  "0000-0001-8466-8259",
  "0009-0008-1469-058X"
  // add more ORCID IDs as needed
];

/* ================================
   ORCID API CALLS
================================ */
async function fetchWorks(orcid) {
  const url = `https://pub.orcid.org/v3.0/${orcid}/works`;
  const res = await fetch(url, {
    headers: { "Accept": "application/json" }
  });
  const data = await res.json();
  return data.group || [];
}

async function fetchWorkDetails(orcid, putCode) {
  const url = `https://pub.orcid.org/v3.0/${orcid}/work/${putCode}`;
  const res = await fetch(url, {
    headers: { "Accept": "application/json" }
  });
  return await res.json();
}

/* ================================
   METADATA HELPERS
================================ */
function getTitleFromSummary(work) {
  return work["work-summary"][0]?.title?.title?.value || "";
}

function getYear(work) {
  return work["publication-date"]?.year?.value || "n.d.";
}

function extractAuthors(work) {
  if (!work?.contributors?.contributor) return "";

  return work.contributors.contributor
    .map(c => c["credit-name"]?.value)
    .filter(Boolean)
    .join(", ");
}

function extractDOI(work) {
  return work["external-ids"]?.["external-id"]
    ?.find(id => id["external-id-type"] === "doi")
    ?.["external-id-value"];
}

/* ================================
   APA-LIKE FORMATTER
================================ */
function formatCitation(work) {
  const authors = extractAuthors(work);
  const year = getYear(work);
  const title = work.title?.title?.value || "Untitled";
  const journal = work["journal-title"]?.value || "";
  const doi = extractDOI(work);

  let citation = "";

  if (authors) {
    citation += `<strong>${authors}</strong> `;
  }

  citation += `(${year}). <strong>${title}</strong>. `;

  if (journal) {
    citation += `<em>${journal}</em>. `;
  }

  if (doi) {
    citation += `<a href="https://doi.org/${doi}" target="_blank">https://doi.org/${doi}</a>`;
  }

  return citation;
}

/* ================================
   LOAD & PROCESS PUBLICATIONS
================================ */
let allPubs = [];

async function loadPublications() {
  let summaries = [];

  for (const orcid of ORCIDS) {
    const works = await fetchWorks(orcid);
    works.forEach(w => {
      const summary = w["work-summary"][0];
      summaries.push({
        orcid: orcid,
        putCode: summary["put-code"],
        title: getTitleFromSummary(w)
      });
    });
  }

  /* Deduplicate by title */
  const seen = new Set();
  summaries = summaries.filter(w => {
    if (!w.title || seen.has(w.title)) return false;
    seen.add(w.title);
    return true;
  });

  /* Fetch full records */
  allPubs = [];
  for (const w of summaries) {
    try {
      const full = await fetchWorkDetails(w.orcid, w.putCode);
      allPubs.push(full);
    } catch (e) {
      console.warn("Failed to fetch work", w, e);
    }
  }

  /* Sort by year descending */
  allPubs.sort((a, b) => {
    const y1 = parseInt(getYear(a)) || 0;
    const y2 = parseInt(getYear(b)) || 0;
    return y2 - y1;
  });

  populateYearFilter();
  render();
}

/* ================================
   UI FUNCTIONS
================================ */
function populateYearFilter() {
  const years = [...new Set(allPubs.map(w => getYear(w)))]
    .filter(y => y !== "n.d.")
    .sort((a, b) => b - a);

  const select = document.getElementById("yearFilter");
  years.forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    select.appendChild(opt);
  });
}

function render() {
  const container = document.getElementById("pubs");
  const searchTerm = document.getElementById("search").value.toLowerCase();
  const yearFilter = document.getElementById("yearFilter").value;

  container.innerHTML = "";

  const filtered = allPubs.filter(w => {
    const text = formatCitation(w).toLowerCase();
    const yearMatch = yearFilter === "all" || getYear(w) === yearFilter;
    return text.includes(searchTerm) && yearMatch;
  });

  if (!filtered.length) {
    container.innerHTML = "<p class='loading'>No matching publications.</p>";
    return;
  }

  const grouped = {};
  filtered.forEach(w => {
    const y = getYear(w);
    if (!grouped[y]) grouped[y] = [];
    grouped[y].push(w);
  });

  Object.keys(grouped)
    .sort((a, b) => b - a)
    .forEach(y => {
      const yearDiv = document.createElement("div");
      yearDiv.className = "year";
      yearDiv.textContent = y;
      container.appendChild(yearDiv);

      grouped[y].forEach(w => {
        const div = document.createElement("div");
        div.className = "pub";
        div.innerHTML = formatCitation(w);
        container.appendChild(div);
      });
    });
}

/* ================================
   EVENTS
================================ */
document.getElementById("search").addEventListener("input", render);
document.getElementById("yearFilter").addEventListener("change", render);

/* ================================
   INIT
================================ */
loadPublications();
</script>

</body>
</html>
